version: 2.1

jobs:
  windows-rdp:
    machine:
      image: windows-server-2022-gui:current
    resource_class: windows.medium
    
    steps:
      - run:
          name: Configure Core RDP Settings
          shell: powershell.exe
          command: |
            # Enable Remote Desktop and disable Network Level Authentication
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                               -Name "fDenyTSConnections" -Value 0 -Force
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                               -Name "UserAuthentication" -Value 0 -Force
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                               -Name "SecurityLayer" -Value 0 -Force

            # Remove any existing rule to avoid duplication
            netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
            
            # Allow incoming connection on port 3389
            netsh advfirewall firewall add rule name="RDP-Tailscale" `
              dir=in action=allow protocol=TCP localport=3389

            # Restart the Remote Desktop service
            Restart-Service -Name TermService -Force
            Write-Host "RDP configured successfully"

      - run:
          name: Create RDP User with Secure Password
          shell: powershell.exe
          command: |
            Add-Type -AssemblyName System.Security
            $charSet = @{
                Upper   = [char[]](65..90)      # A-Z
                Lower   = [char[]](97..122)     # a-z
                Number  = [char[]](48..57)      # 0-9
                Special = ([char[]](33..47) + [char[]](58..64) +
                           [char[]](91..96) + [char[]](123..126))
            }
            $rawPassword = @()
            $rawPassword += $charSet.Upper | Get-Random -Count 4
            $rawPassword += $charSet.Lower | Get-Random -Count 4
            $rawPassword += $charSet.Number | Get-Random -Count 4
            $rawPassword += $charSet.Special | Get-Random -Count 4
            $password = -join ($rawPassword | Sort-Object { Get-Random })
            $securePass = ConvertTo-SecureString $password -AsPlainText -Force
            
            # Create user
            New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -ErrorAction Stop
            Add-LocalGroupMember -Group "Administrators" -Member "RDP"
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
            
            # Save password to file for display later
            $password | Out-File -FilePath "$env:TEMP\rdp_password.txt" -Force
            
            Write-Host "User 'RDP' created successfully"
            
            if (-not (Get-LocalUser -Name "RDP")) {
                Write-Error "User creation failed"
                exit 1
            }

      - run:
          name: Install Tailscale
          shell: powershell.exe
          command: |
            $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
            $installerPath = "$env:TEMP\tailscale.msi"
            
            Write-Host "Downloading Tailscale..."
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
            
            Write-Host "Installing Tailscale..."
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
            Remove-Item $installerPath -Force
            
            Write-Host "Tailscale installed successfully"

      - run:
          name: Establish Tailscale Connection
          shell: powershell.exe
          command: |
            Write-Host "Connecting to Tailscale network..."
            
            # Bring up Tailscale with auth key
            & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=circleci-rdp-$env:CIRCLE_BUILD_NUM
            
            # Wait for Tailscale to assign an IP
            $tsIP = $null
            $retries = 0
            while (-not $tsIP -and $retries -lt 15) {
                Start-Sleep -Seconds 3
                $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                $retries++
            }
            
            if (-not $tsIP) {
                Write-Error "Tailscale IP not assigned. Exiting."
                exit 1
            }
            
            # Save IP to file
            $tsIP | Out-File -FilePath "$env:TEMP\tailscale_ip.txt" -Force
            Write-Host "Tailscale IP: $tsIP"
      
      - run:
          name: Verify RDP Accessibility
          shell: powershell.exe
          command: |
            $tsIP = Get-Content "$env:TEMP\tailscale_ip.txt"
            Write-Host "Testing RDP connectivity to $tsIP..."
            
            # Test connectivity
            $testResult = Test-NetConnection -ComputerName $tsIP -Port 3389 -WarningAction SilentlyContinue
            if (-not $testResult.TcpTestSucceeded) {
                Write-Error "TCP connection to RDP port 3389 failed"
                exit 1
            }
            Write-Host "âœ“ TCP connectivity successful!"

      - run:
          name: Maintain Connection
          shell: powershell.exe
          no_output_timeout: 360m
          command: |
            $tsIP = Get-Content "$env:TEMP\tailscale_ip.txt"
            $password = Get-Content "$env:TEMP\rdp_password.txt"
            
            Write-Host "`n=========================================="
            Write-Host "       RDP ACCESS READY"
            Write-Host "=========================================="
            Write-Host "Address:  $tsIP"
            Write-Host "Username: RDP"
            Write-Host "Password: $password"
            Write-Host "=========================================="
            Write-Host "`nConnection will remain active for 6 hours"
            Write-Host "Press 'Cancel Build' in CircleCI to terminate`n"
            
            # Keep runner active
            $endTime = (Get-Date).AddHours(6)
            while ((Get-Date) -lt $endTime) {
                $remaining = ($endTime - (Get-Date)).ToString("hh\:mm\:ss")
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP Active - Time remaining: $remaining"
                Start-Sleep -Seconds 300
            }
            
            Write-Host "`nSession time limit reached. Shutting down..."

workflows:
  version: 2
  rdp-workflow:
    jobs:
      - windows-rdp:
          context:
            - tailscale-secrets
